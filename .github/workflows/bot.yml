name: Telegram Bot

on:
  push:
    branches:
      - main
  workflow_dispatch:  # –ö–Ω–æ–ø–∫–∞ "Run workflow"
  schedule:
    - cron: '*/5 * * * *'  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

jobs:
  run-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v3

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: pip install -r requirements.txt

      - name: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å
        run: |
          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
          pkill -f "python bot.py" || true
          sleep 5
          rm -f .bot_lock  # –û—á–∏—Å—Ç–∫–∞ lock-—Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –±–æ—Ç —É–ø–∞–ª

      - name: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –±–æ—Ç
        run: |
          if [ -f ".bot_lock" ]; then
            echo "‚ùå –ë–æ—Ç —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω."
            exit 0
          fi
          echo "üîí –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å..." > .bot_lock

      - name: –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è..."
          trap 'rm -f .bot_lock' EXIT  # –£–¥–∞–ª—è–µ–º lock-—Ñ–∞–π–ª –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
          python bot.py || true  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã workflow –Ω–µ –ø–∞–¥–∞–ª
